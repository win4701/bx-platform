<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bloxio ‚Ä¢ BX on TON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Basic Security -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://telegram.org https://*.tonscan.org https://*.ston.fi;
                 script-src 'self' 'unsafe-inline' https://telegram.org;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data: https:;
                 connect-src *;">

  <style>
    :root {
      --bg: #0b0f14;
      --card: #121826;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --gold: #f59e0b;
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 16px;
      text-align: center;
      font-weight: 700;
      font-size: 18px;
      background: linear-gradient(90deg, #111827, #020617);
    }

    main {
      padding: 16px;
      display: grid;
      gap: 14px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .value {
      font-size: 20px;
      font-weight: 700;
    }

    button {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius);
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    .btn-primary { background: var(--primary); color: #fff; }
    .btn-success { background: var(--success); color: #022c22; }
    .btn-gold    { background: var(--gold); color: #422006; }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: none;
      background: #020617;
      color: var(--text);
      margin-top: 8px;
    }

    footer {
      text-align: center;
      padding: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .hidden { display: none; }
  </style>
</head>

<body>
  <header>üöÄ Bloxio ‚Ä¢ BX on TON</header>

  <main>
    <!-- USER -->
    <div class="card">
      <div class="row">
        <div>
          <div class="muted">Telegram User</div>
          <div id="username" class="value">‚Äî</div>
        </div>
        <div>
          <div class="muted">ID</div>
          <div id="userid">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- BALANCE -->
    <div class="card">
      <div class="row">
        <div>
          <div class="muted">BX Balance</div>
          <div id="balance" class="value">0.00</div>
        </div>
      </div>
      <button class="btn-success" onclick="claim()">üéÅ Claim BX</button>
    </div>

    <!-- SWAP -->
    <div class="card">
      <div class="muted">Swap TON ‚Üí BX</div>
      <input id="swapAmount" type="number" placeholder="Amount in TON" />
      <div id="quote" class="muted"></div>
      <button class="btn-primary" onclick="previewSwap()">üîÑ Preview Swap</button>
    </div>

    <!-- REFERRAL -->
    <div class="card">
      <div class="muted">Referral</div>
      <div id="refStats">Loading‚Ä¶</div>
      <button class="btn-gold" onclick="copyRef()">üìã Copy Referral Link</button>
    </div>

    <!-- ADMIN (Hidden by default) -->
    <div id="adminBox" class="card hidden">
      <div class="muted">Admin Dashboard</div>
      <pre id="adminData">‚Äî</pre>
    </div>
  </main>

  <footer>¬© Bloxio ‚Ä¢ Powered by TON</footer>

  <script>
    /* =========================
       Telegram Bootstrap
    ========================= */
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const user = tg.initDataUnsafe?.user;
    if (user) {
      document.getElementById("username").innerText =
        user.username ? "@" + user.username : user.first_name;
      document.getElementById("userid").innerText = user.id;
    }

    /* =========================
       API Helper (Secure)
    ========================= */
    async function api(path, method = "GET", body = null) {
      const res = await fetch(path, {
        method,
        headers: {
          "Content-Type": "application/json",
          "x-telegram-init-data": tg.initData
        },
        body: body ? JSON.stringify(body) : null
      });
      return res.json();
    }

    /* =========================
       Balance
    ========================= */
    async function loadBalance() {
      const r = await api("/api/balance");
      if (r?.balance !== undefined) {
        document.getElementById("balance").innerText = r.balance;
      }
    }

    /* =========================
       Claim
    ========================= */
    async function claim() {
      const r = await api("/api/claim", "POST");
      if (r?.ok) {
        alert("Claim successful");
        loadBalance();
      } else {
        alert(r?.error || "Claim failed");
      }
    }

    /* =========================
       Swap Preview
    ========================= */
    async function previewSwap() {
      const amount = Number(document.getElementById("swapAmount").value);
      if (!amount) return;

      const q = await api("/api/quote", "POST", {
        from: "TON",
        to: "BX",
        amount
      });

      if (q?.error) {
        document.getElementById("quote").innerText = q.error;
        return;
      }

      document.getElementById("quote").innerText =
        `Receive ‚âà ${q.toAmount} BX
Min (${q.slippage}%): ${q.minReceive.toFixed(4)}`;
    }

    /* =========================
       Referral
    ========================= */
    async function loadReferral() {
      const r = await api("/api/referral");
      if (!r) return;

      window._refLink = r.link;
      document.getElementById("refStats").innerText =
        `Level: ${r.level}
Invited: ${r.total}
Earned: ${r.earned} BX`;
    }

    function copyRef() {
      if (!window._refLink) return;
      navigator.clipboard.writeText(window._refLink);
      alert("Referral link copied");
    }

    /* =========================
       Admin (auto-detect)
    ========================= */
    async function loadAdmin() {
      try {
        const r = await api("/admin/status");
        if (r?.status) {
          document.getElementById("adminBox").classList.remove("hidden");
          document.getElementById("adminData").innerText =
            JSON.stringify(r, null, 2);
        }
      } catch (_) {}
    }

    /* =========================
       Init
    ========================= */
    loadBalance();
    loadReferral();
    loadAdmin();
  </script>
</body>
</html>
